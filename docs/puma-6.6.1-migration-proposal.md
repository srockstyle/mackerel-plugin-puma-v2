# mackerel-plugin-puma-v2 実装提案書

## エグゼクティブサマリー

本ドキュメントは、mackerel-plugin-puma-v2 として新規に実装する Puma 監視プラグインの包括的な実装提案書です。オリジナルの mackerel-plugin-puma が7年間更新されていない状況を踏まえ、最新の Puma 6.6.1 に完全対応した新しいプラグインとして設計・実装します。

## 現状分析結果

### 根本的な課題（Analyzer による分析）

#### 主要な問題点
1. **API 互換性の問題**（確信度: 85%）
   - 7年間の Puma バージョンアップ（v3.x → v6.x）による潜在的な非互換性
   - /gc-stats エンドポイントの廃止可能性

2. **監視項目の不足**（確信度: 90%）
   - 基本的なメトリクスのみ（workers, threads, backlog）
   - 最新の Puma で利用可能な重要メトリクスの欠如

3. **エラーハンドリングの欠陥**（確信度: 95%）
   - エラー時の詳細情報なし
   - リトライメカニズムの欠如
   - タイムアウト設定なし

#### 根本原因
- 継続的メンテナンスプロセスの欠如
- 初期設計時の拡張性・保守性への配慮不足
- プロダクション環境での実運用経験の不足

### アーキテクチャ評価（Architect による分析）

#### 構造的問題
1. **モノリシックな設計**
   - 単一ファイルに全ロジックが集中
   - 責任の分離がされていない

2. **抽象化の欠如**
   - Puma API への直接依存
   - テスタビリティの低さ

3. **拡張性の制限**
   - 新メトリクス追加が困難
   - バージョン間の差異吸収が不可能

### コード品質評価（Reviewer による分析）

#### Critical な問題
1. **Unix Socket 通信の脆弱性**
   - 固定バッファサイズによるデータ切り詰めリスク
   - 不適切な HTTP レスポンスパース

2. **リソース管理の不備**
   - エラー時のリソースリーク可能性
   - defer の不適切な使用

3. **Go モジュール未使用**
   - 依存関係管理の欠如
   - 再現可能なビルドの困難さ

## 推奨アーキテクチャ

### Clean Architecture ベースの設計

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  ┌─────────────────┐  ┌──────────────────────────────┐ │
│  │ CLI Interface   │  │ Mackerel Output Formatter    │ │
│  └─────────────────┘  └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                    Application Layer                     │
│  ┌─────────────────┐  ┌──────────────────────────────┐ │
│  │ MetricsCollector│  │ Configuration Manager        │ │
│  │    UseCase      │  │                              │ │
│  └─────────────────┘  └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                      Domain Layer                        │
│  ┌─────────────────┐  ┌──────────────────────────────┐ │
│  │ Metric Entity   │  │ Metric Definitions           │ │
│  └─────────────────┘  └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                    │
│  ┌─────────────────┐  ┌──────────────────────────────┐ │
│  │ PumaAPIClient   │  │ HTTPClient with Retry        │ │
│  │ (Version Aware) │  │                              │ │
│  └─────────────────┘  └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 主要な設計原則
- **SOLID 原則**の遵守
- **依存性逆転**による疎結合
- **インターフェース分離**による拡張性
- **バージョン戦略パターン**による互換性管理

## 新規監視項目の提案

### Puma 6.x で追加すべきメトリクス

#### 1. パフォーマンスメトリクス
- **リクエスト処理統計**
  - `puma.requests.total` - 総リクエスト数
  - `puma.requests.queue_time` - キュー待機時間
  - `puma.requests.processing_time` - 処理時間分布

#### 2. リソース使用状況
- **メモリ使用量**
  - `puma.memory.workers` - ワーカーごとのメモリ
  - `puma.memory.total` - 総メモリ使用量
  - `puma.memory.rss` - RSS メモリ

#### 3. 詳細なスレッド情報
- **スレッドプール統計**
  - `puma.threads.active` - アクティブスレッド数
  - `puma.threads.idle` - アイドルスレッド数
  - `puma.threads.utilization` - 使用率（%）

#### 4. 接続管理
- **接続統計**
  - `puma.connections.active` - アクティブ接続数
  - `puma.connections.waiting` - 待機中接続数
  - `puma.connections.rejected` - 拒否された接続数

#### 5. エラー監視
- **エラー統計**
  - `puma.errors.total` - 総エラー数
  - `puma.errors.timeout` - タイムアウトエラー
  - `puma.errors.5xx` - 5xx エラー数

## 実装計画

### Phase 1: 基盤整備（1週間）

#### 週 1-2
- [ ] Go modules 導入（go.mod 作成）
- [ ] 基本的なプロジェクト構造の作成
- [ ] CI/CD パイプラインの設定（GitHub Actions）

#### 週 3-4
- [ ] Critical なバグ修正
  - Unix Socket 通信の安全性向上
  - エラーハンドリングの改善
  - リソースリークの修正

### Phase 2: アーキテクチャ改善（2週間）

#### 週 1
- [ ] ドメイン層の実装
  - Metric エンティティ
  - メトリクス定義
- [ ] インフラストラクチャ層の基盤
  - HTTP クライアント抽象化
  - リトライメカニズム

#### 週 2
- [ ] アプリケーション層の実装
  - MetricsCollector
  - Configuration Manager
- [ ] プレゼンテーション層の改修
  - CLI インターフェース
  - 出力フォーマッター

### Phase 3: Puma 6.x 対応（2週間）

#### 週 1
- [ ] Puma 6.x API の調査と実装
  - 新エンドポイントの確認
  - レスポンス形式の対応
- [ ] バージョン検出機能の実装
- [ ] 後方互換性の確保

#### 週 2
- [ ] 新メトリクスの実装
  - リクエスト統計
  - メモリ使用量
  - 詳細なスレッド情報
- [ ] 統合テストの作成

### Phase 4: 品質向上（1週間）

- [ ] 包括的なテストスイート
  - 単体テスト（カバレッジ 80% 以上）
  - 統合テスト
  - E2E テスト
- [ ] ドキュメント整備
  - 使用方法
  - 設定例
  - トラブルシューティング
- [ ] パフォーマンス最適化

## リスクと対策

### 技術的リスク
1. **Puma API の非公開変更**
   - 対策: バージョン検出と graceful degradation
   
2. **後方互換性の破壊**
   - 対策: 段階的移行とフィーチャーフラグ

3. **パフォーマンス劣化**
   - 対策: ベンチマークテストと最適化

### 運用リスク
1. **移行時の監視断絶**
   - 対策: 並行運用期間の設定

2. **設定変更の複雑化**
   - 対策: 移行ガイドと自動検出

## 成功指標

### 定量的指標
- テストカバレッジ: 80% 以上
- パフォーマンス: 現行比 同等以上
- メモリ使用量: 現行比 110% 以内
- エラー率: 0.1% 以下

### 定性的指標
- Puma 6.x での動作確認
- 新メトリクスの有用性確認
- コードの保守性向上
- ドキュメントの充実度

## v2 としての新規実装の利点

### 技術的利点
1. **レガシーコードからの完全な脱却**
   - 7年分の技術的負債を引き継がない
   - 最新のベストプラクティスに基づく実装

2. **最新技術スタックの採用**
   - Go 1.21+ の新機能活用
   - 最新の依存ライブラリ使用
   - モダンなテストフレームワーク

3. **後方互換性の制約からの解放**
   - 最適な API 設計が可能
   - パフォーマンス優先の実装

### ビジネス的利点
1. **明確な差別化**
   - v2 として新しいプロダクトであることを明示
   - ユーザーの期待値管理が容易

2. **独立したリリースサイクル**
   - オリジナルへの影響を考慮不要
   - 迅速な機能追加とバグ修正

## 結論

mackerel-plugin-puma-v2 は、単なるアップデートではなく、最新の Puma 6.6.1 に完全対応した新世代の監視プラグインとして位置付けられます。Clean Architecture に基づく設計により、将来的な拡張性と保守性を確保し、今後の Puma バージョンアップにも柔軟に対応できる堅牢なソリューションを提供します。

特に重要なのは：
1. **ゼロからの設計による最適化**
2. **最新技術スタックの活用**
3. **継続的なメンテナンスの保証**

これらにより、エンタープライズグレードの Puma 監視ソリューションの実現が可能となります。